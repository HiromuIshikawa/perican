#!/usr/bin/env ruby

################################################################
# rbenv support:
# If this file is a symlink, and bound to a specific ruby
# version via rbenv (indicated by RBENV_VERSION),
# I want to resolve the symlink and re-exec
# the original executable respecting the .ruby_version
# which should indicate the right version.
#
if File.symlink?(__FILE__) and ENV["RBENV_VERSION"]
  ENV["RBENV_VERSION"] = nil
  shims_path = File.expand_path("shims", ENV["RBENV_ROOT"])
  ENV["PATH"] = shims_path + ":" + ENV["PATH"]
  exec(File.readlink(__FILE__), *ARGV)
end

ENV["BUNDLE_GEMFILE"] = File.expand_path("../../Gemfile", __FILE__)

require "rubygems"
require "bundler/setup"
require "perican/metadata"
require "perican/resource"

Encoding.default_external = "UTF-8"

file = File.open(File.expand_path("~/.config/perican/auth.txt"))
gmail_user = file.gets.chomp
gmail_pass = file.gets.chomp
evernote_consumer_key = file.gets.chomp
evernote_consumer_secret = file.gets.chomp
evernote_access_token = file.gets.chomp
file.close

m = Perican::Resource::Mail.collection(gmail_user, gmail_pass).map(&:metadata)
e = Perican::Resource::Evernote.collection(evernote_consumer_key,
                                           evernote_consumer_secret,
                                           evernote_access_token).map(&:metadata)

resources = (m + e) # .sort {|a,b| a.date <=> b.date}
resources.each do |r|
  puts "#{r.date} #{r.summary}"
end
